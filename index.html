<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Govee Light Dashboard</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

  body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    background: #f5f7fa;
    color: #333;
  }

  header {
    background: #4a90e2;
    color: white;
    padding: 30px 20px;
    text-align: center;
    font-size: 2em;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  main {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    padding: 30px;
  }

  .card {
    background: white;
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 25px rgba(0,0,0,0.12);
  }

  h2 {
    margin-top: 0;
    font-size: 1.3em;
    margin-bottom: 15px;
    color: #4a90e2;
  }

  select, input[type=color], input[type=range], button {
    width: 100%;
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 12px;
    border: 1px solid #ddd;
    box-sizing: border-box;
    font-size: 1em;
  }

  input[type=range] {
    padding: 0;
    height: 8px;
  }

  button {
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s ease;
  }

  button:hover {
    opacity: 0.9;
  }

  .on { background: #4CAF50; color: white; }
  .off { background: #E53935; color: white; }
  .blue { background: #4a90e2; color: white; }

  #status {
    font-weight: 600;
    margin-top: 10px;
  }

  .control-group {
    display: flex;
    gap: 10px;
  }

  .control-group button {
    flex: 1;
  }

  .preset-btn {
    background: #f39c12;
    color: white;
    font-weight: 600;
  }

  .preset-btn:hover {
    background: #e67e22;
  }
</style>
</head>
<body>

<header>ðŸ’¡ Govee Light Dashboard</header>

<main>
  <!-- Devices Panel -->
  <div class="card">
    <h2>Devices</h2>
    <button id="refresh" class="blue">ðŸ”„ Refresh Devices</button>
    <select id="deviceSelect"></select>
    <p id="status">Status: Waiting...</p>
  </div>

  <!-- Color Panel -->
  <div class="card">
    <h2>ðŸŽ¨ Color Control</h2>
    <input type="color" id="colorPicker" value="#ffffff">
    <button id="setColor" class="blue">Set Color</button>
  </div>

  <!-- Brightness Panel -->
  <div class="card">
    <h2>ðŸ’¡ Brightness Control</h2>
    <label>Brightness: <span id="brightnessValue">100</span>%</label>
    <input type="range" id="brightness" min="0" max="100" value="100">
    <button id="setBrightness" class="blue">Set Brightness</button>
  </div>

  <!-- Power Panel -->
  <div class="card">
    <h2>Power Control</h2>
    <div class="control-group">
      <button id="turnOn" class="on">Turn ON</button>
      <button id="turnOff" class="off">Turn OFF</button>
    </div>
  </div>

  <!-- Presets Panel -->
  <div class="card">
    <h2>Presets</h2>
    <button id="bedtime" class="preset-btn">ðŸŒ™ Bedtime</button>
    <small>Sets brightness to 4% and warm white</small>
  </div>
</main>

<script>
const API_KEY = "f4b87beb-7426-4751-9cbd-811d08300ea8";
const API_BASE = "https://developer-api.govee.com/v1";

const statusEl = document.getElementById('status');
const deviceSelect = document.getElementById('deviceSelect');
const brightnessSlider = document.getElementById('brightness');
const brightnessValue = document.getElementById('brightnessValue');

document.getElementById('refresh').addEventListener('click', fetchDevices);
document.getElementById('setColor').addEventListener('click', setColor);
document.getElementById('setBrightness').addEventListener('click', setBrightness);
document.getElementById('turnOn').addEventListener('click', () => sendCommand('turn', 'on'));
document.getElementById('turnOff').addEventListener('click', () => sendCommand('turn', 'off'));
document.getElementById('bedtime').addEventListener('click', bedtimePreset);

brightnessSlider.addEventListener('input', () => {
  brightnessValue.textContent = brightnessSlider.value;
});

async function fetchDevices() {
  statusEl.textContent = 'Status: Fetching devices...';
  try {
    const res = await fetch(`${API_BASE}/devices`, {
      headers: { 'Govee-API-Key': API_KEY }
    });
    const data = await res.json();
    const devices = data.data?.devices || [];
    deviceSelect.innerHTML = '';
    if (devices.length === 0) {
      const opt = document.createElement('option');
      opt.textContent = '-- No devices found --';
      deviceSelect.appendChild(opt);
      statusEl.textContent = 'No devices found. Check API key.';
      return;
    }
    devices.forEach(dev => {
      const opt = document.createElement('option');
      opt.value = JSON.stringify(dev);
      opt.textContent = dev.deviceName || dev.model || 'Unknown Device';
      deviceSelect.appendChild(opt);
    });
    statusEl.textContent = `Found ${devices.length} device(s).`;
  } catch (err) {
    console.error(err);
    statusEl.textContent = 'Error fetching devices.';
  }
}

async function sendCommand(name, value) {
  if (!deviceSelect.value) {
    statusEl.textContent = 'Select a device first';
    return;
  }

  const selected = JSON.parse(deviceSelect.value);
  const deviceId = selected.device || selected.deviceId || selected.deviceName;
  const model = selected.model || selected.sku || selected.deviceType;

  if (!deviceId || !model) {
    statusEl.textContent = 'Error: Device or model missing.';
    return;
  }

  const body = { device: deviceId, model, cmd: { name, value } };

  try {
    const res = await fetch(`${API_BASE}/devices/control`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Govee-API-Key': API_KEY },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (res.ok && data.message === "success") {
      statusEl.textContent = 'âœ… Command sent successfully!';
    } else {
      statusEl.textContent = 'âš ï¸ Error: ' + JSON.stringify(data);
    }
  } catch (err) {
    console.error(err);
    statusEl.textContent = 'âŒ Failed to send command.';
  }
}

function hexToRgb(hex) {
  const bigint = parseInt(hex.slice(1), 16);
  return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
}

function setColor() {
  const hex = document.getElementById('colorPicker').value;
  const rgb = hexToRgb(hex);
  sendCommand('color', rgb);
}

function setBrightness() {
  const val = parseInt(brightnessSlider.value);
  sendCommand('brightness', val);
}

// Bedtime Preset: 4% brightness, warm white (approx RGB 255, 147, 41)
function bedtimePreset() {
  brightnessSlider.value = 4;
  brightnessValue.textContent = 4;
  sendCommand('brightness', 4);
  sendCommand('color', { r: 255, g: 147, b: 41 });
}

// Initial fetch
fetchDevices();
</script>
</body>
</html>

