<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ’¡ Govee Dashboard Pro</title>
<style>
body{margin:0;font-family:Inter,sans-serif;background:#121212;color:#e0e0e0;}
header{background:#1f1f1f;color:#4a90e2;padding:30px;text-align:center;font-size:2em;box-shadow:0 4px 12px rgba(0,0,0,0.5);}
main{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;padding:30px;}
.card{background:#1e1e1e;border-radius:20px;padding:25px;box-shadow:0 8px 20px rgba(0,0,0,0.6);transition:transform 0.2s,box-shadow 0.2s;}
.card:hover{transform:translateY(-5px);box-shadow:0 12px 25px rgba(0,0,0,0.8);}
h2{margin-top:0;color:#4a90e2;}
select,input[type=color],input[type=range],button,input[type=time],input[type=text]{width:100%;margin-bottom:15px;padding:10px;border-radius:12px;border:none;background:#2c2c2c;color:#e0e0e0;font-size:1em;box-sizing:border-box;}
input[type=range]{padding:0;height:8px;}
button{cursor:pointer;font-weight:600;transition:background 0.2s;}
button:hover{opacity:0.85;}
.on{background:#4CAF50;color:white;}
.off{background:#E53935;color:white;}
.blue{background:#4a90e2;color:white;}
.preset-btn{background:#f39c12;color:white;font-weight:600;}
.preset-btn:hover{background:#e67e22;}
#status{font-weight:600;margin-top:10px;}
.control-group{display:flex;gap:10px;}
.control-group button{flex:1;}
#deviceState{margin-top:10px;padding:10px;background:#2a2a2a;border-radius:10px;}
</style>
</head>
<body>
<header>ğŸ’¡ Govee Dashboard Pro</header>
<main>

<div class="card">
<h2>Devices</h2>
<button id="refresh" class="blue">ğŸ”„ Refresh Devices</button>
<select id="deviceSelect"></select>
<p id="status">Status: Waiting...</p>
<div id="deviceState">
<p>Power: <span id="statePower">-</span></p>
<p>Brightness: <span id="stateBrightness">-</span></p>
<p>Color Temp: <span id="stateTemp">-</span></p>
<p>RGB: <span id="stateRGB">-</span></p>
</div>
<label><input type="checkbox" id="applyAll"> Apply to ALL devices</label>
</div>

<div class="card">
<h2>ğŸ¨ Color Control</h2>
<input type="color" id="colorPicker" value="#ffffff">
<button id="setColor" class="blue">Set Color</button>
</div>

<div class="card">
<h2>ğŸ’¡ Brightness</h2>
<label>Brightness: <span id="brightnessValue">100</span>%</label>
<input type="range" id="brightness" min="0" max="100" value="100">
<button id="setBrightness" class="blue">Set Brightness</button>
</div>

<div class="card">
<h2>Power</h2>
<div class="control-group">
<button id="turnOn" class="on">Turn ON</button>
<button id="turnOff" class="off">Turn OFF</button>
</div>
</div>

<div class="card">
<h2>Presets</h2>
<button class="preset-btn" id="preset1">ğŸŒ™ Bedtime</button>
<button class="preset-btn" id="preset2">ğŸ¬ Movie</button>
<button class="preset-btn" id="preset3">ğŸ“– Reading</button>
<button class="preset-btn" id="preset4">ğŸ›€ Relax</button>
<button class="preset-btn" id="preset5">ğŸ‰ Party</button>
<button class="preset-btn" id="preset6">ğŸŒ… Sunrise</button>
<button class="preset-btn" id="preset7">ğŸŒ‡ Sunset</button>
<button class="preset-btn" id="preset8">âš¡ Focus</button>
<button class="preset-btn" id="preset9">â¤ï¸ Romantic</button>
<button class="preset-btn" id="preset10">â˜€ï¸ Energy</button>
</div>

<div class="card">
<h2>Custom Scene</h2>
<input type="text" id="sceneName" placeholder="Scene Name">
<input type="color" id="sceneColor" value="#ffffff">
<input type="range" id="sceneBrightness" min="0" max="100" value="100">
<button id="saveScene" class="blue">Save & Apply Scene</button>
</div>

<div class="card">
<h2>Scheduler</h2>
<label>Time: <input type="time" id="scheduleTime"></label>
<select id="schedulePreset">
<option value="bedtime">ğŸŒ™ Bedtime</option>
<option value="movieMode">ğŸ¬ Movie</option>
<option value="readingMode">ğŸ“– Reading</option>
<option value="relaxMode">ğŸ›€ Relax</option>
<option value="partyMode">ğŸ‰ Party</option>
<option value="sunriseMode">ğŸŒ… Sunrise</option>
<option value="sunsetMode">ğŸŒ‡ Sunset</option>
<option value="focusMode">âš¡ Focus</option>
<option value="romanticMode">â¤ï¸ Romantic</option>
<option value="energyBoostMode">â˜€ï¸ Energy</option>
</select>
<button id="addSchedule" class="blue">Add Schedule</button>
<ul id="scheduleList"></ul>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
const API_KEY="f4b87beb-7426-4751-9cbd-811d08300ea8";
const API_BASE="https://developer-api.govee.com/v1";
let discoInterval=null, pollInterval=null;
let savedScenes={}, schedules=[];

const statusEl=document.getElementById('status');
const deviceSelect=document.getElementById('deviceSelect');
const brightnessSlider=document.getElementById('brightness');
const brightnessValue=document.getElementById('brightnessValue');
const statePower=document.getElementById('statePower');
const stateBrightness=document.getElementById('stateBrightness');
const stateTemp=document.getElementById('stateTemp');
const stateRGB=document.getElementById('stateRGB');
const applyAll=document.getElementById('applyAll');

function hexToRgb(hex){ const bigint=parseInt(hex.slice(1),16); return { r:(bigint>>16)&255, g:(bigint>>8)&255, b:bigint&255 }; }
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

async function sendCommandQueued(name,value){
  let devices=[deviceSelect.value?JSON.parse(deviceSelect.value):null];
  if(applyAll.checked){
    devices=Array.from(deviceSelect.options).map(o=>JSON.parse(o.value));
  }
  for(let selected of devices){
    if(!selected) continue;
    const deviceId=selected.device||selected.deviceId||selected.deviceName;
    const model=selected.model||selected.sku||selected.deviceType;
    if(!deviceId||!model){ statusEl.textContent='Device/model missing'; continue; }
    try{
      await fetch(`${API_BASE}/devices/control`,{
        method:'PUT',
        headers:{ 'Content-Type':'application/json','Govee-API-Key':API_KEY },
        body: JSON.stringify({ device:deviceId, model:model, cmd:{name,value} })
      });
      await sleep(200); // small delay to prevent rate limit
    }catch(err){ console.error(err); }
  }
}

// ---------------- DEVICE STATE ----------------
async function fetchDevices(){
  statusEl.textContent='Fetching devices...';
  try{
    const res=await fetch(`${API_BASE}/devices`,{ headers:{'Govee-API-Key':API_KEY} });
    const data=await res.json();
    const devices=data.data?.devices||[];
    deviceSelect.innerHTML='';
    if(devices.length===0){ deviceSelect.innerHTML='<option>No devices</option>'; statusEl.textContent='No devices'; return; }
    devices.forEach(dev=>{ const opt=document.createElement('option'); opt.value=JSON.stringify(dev); opt.textContent=dev.deviceName||dev.model||'Unknown'; deviceSelect.appendChild(opt); });
    statusEl.textContent=`Found ${devices.length} device(s)`;
  }catch(err){ console.error(err); statusEl.textContent='Error fetching devices'; }
}

async function updateDeviceState(){
  if(!deviceSelect.value) return;
  const selected=JSON.parse(deviceSelect.value);
  const deviceId=selected.device||selected.deviceId||selected.deviceName;
  const model=selected.model||selected.sku||selected.deviceType;
  try{
    const res=await fetch(`${API_BASE}/devices/state?device=${deviceId}&model=${model}`,{ headers:{'Govee-API-Key':API_KEY} });
    const data=await res.json();
    const props=data.data?.properties||[];
    const powerObj=props.find(p=>p.name==='power')||{};
    const brightnessObj=props.find(p=>p.name==='brightness')||{};
    const tempObj=props.find(p=>p.name==='colorTem')||{};
    const colorObj=props.find(p=>p.name==='color')||{};
    statePower.textContent=powerObj.value||'-';
    stateBrightness.textContent=brightnessObj.value||'-';
    stateTemp.textContent=tempObj.value||'-';
    stateRGB.textContent=colorObj.value?`R:${colorObj.value.r} G:${colorObj.value.g} B:${colorObj.value.b}`:'-';
    if(brightnessObj.value){ brightnessSlider.value=brightnessObj.value; brightnessValue.textContent=brightnessObj.value; }
  }catch(err){ console.error(err); }
}

function startPolling(){ if(pollInterval) clearInterval(pollInterval); pollInterval=setInterval(updateDeviceState,5000); updateDeviceState(); }

// ---------------- EVENTS ----------------
document.getElementById('refresh').addEventListener('click',fetchDevices);
document.getElementById('setColor').addEventListener('click',()=>sendCommandQueued('color',hexToRgb(document.getElementById('colorPicker').value)));
document.getElementById('setBrightness').addEventListener('click',()=>sendCommandQueued('brightness',parseInt(brightnessSlider.value)));
document.getElementById('turnOn').addEventListener('click',()=>sendCommandQueued('turn','on'));
document.getElementById('turnOff').addEventListener('click',()=>sendCommandQueued('turn','off'));
brightnessSlider.addEventListener('input',()=>{ brightnessValue.textContent=brightnessSlider.value; });

// ---------------- PRESETS ----------------
function stopDisco(){ if(discoInterval){ clearInterval(discoInterval); discoInterval=null; } }

async function applyPreset(colorTemp,brightness,color){
  stopDisco();
  if(colorTemp) await sendCommandQueued('colorTem',colorTemp);
  if(color) await sendCommandQueued('color',color);
  if(brightness!==undefined) await sendCommandQueued('brightness',brightness);
}

document.getElementById('preset1').addEventListener('click',()=>applyPreset(2700,4));       // Bedtime
document.getElementById('preset2').addEventListener('click',()=>applyPreset(null,20,{r:0,g:0,b:100})); // Movie
document.getElementById('preset3').addEventListener('click',()=>applyPreset(4000,90));   // Reading
document.getElementById('preset4').addEventListener('click',()=>applyPreset(3000,40));   // Relax
document.getElementById('preset5').addEventListener('click',()=>{
  stopDisco();
  let colors=[{r:255,g:0,b:0},{r:0,g:255,b:0},{r:0,g:0,b:255},{r:255,g:255,b:0}];
  let i=0;
  discoInterval=setInterval(()=>{ sendCommandQueued('color',colors[i]); sendCommandQueued('brightness',100); i=(i+1)%colors.length; },700);
});
document.getElementById('preset6').addEventListener('click',()=>applyPreset(2700,70));
document.getElementById('preset7').addEventListener('click',()=>applyPreset(2700,30));
document.getElementById('preset8').addEventListener('click',()=>applyPreset(5000,100));
document.getElementById('preset9').addEventListener('click',()=>applyPreset(null,40,{r:255,g:100,b:150}));
document.getElementById('preset10').addEventListener('click',()=>applyPreset(6500,100));

// ---------------- SCENES ----------------
document.getElementById('saveScene').addEventListener('click',async ()=>{
  const name=document.getElementById('sceneName').value.trim();
  const color=hexToRgb(document.getElementById('sceneColor').value);
  const brightness=parseInt(document.getElementById('sceneBrightness').value);
  if(!name) return alert('Enter scene name');
  savedScenes[name]={color,brightness};
  await sendCommandQueued('color',color);
  await sendCommandQueued('brightness',brightness);
  statusEl.textContent=`ğŸ’¾ Applied scene: ${name}`;
});

// ---------------- SCHEDULER ----------------
function checkSchedules(){
  const now=new Date();
  const timeStr=now.toTimeString().slice(0,5);
  for(let s of schedules){ if(s.time===timeStr){ s.action(); statusEl.textContent=`â° Scheduled: ${s.name}`; } }
}
document.getElementById('addSchedule').addEventListener('click',()=>{
  const time=document.getElementById('scheduleTime').value;
  const preset=document.getElementById('schedulePreset').value;
  if(!time) return alert('Select time');
  let action;
  switch(preset){
    case 'bedtime': action=()=>applyPreset(2700,4); break;
    case 'movieMode': action=()=>applyPreset(null,20,{r:0,g:0,b:100}); break;
    case 'readingMode': action=()=>applyPreset(4000,90); break;
    case 'relaxMode': action=()=>applyPreset(3000,40); break;
    case 'partyMode': action=()=>{
      let colors=[{r:255,g:0,b:0},{r:0,g:255,b:0},{r:0,g:0,b:255},{r:255,g:255,b:0}];
      let i=0;
      discoInterval=setInterval(()=>{ sendCommandQueued('color',colors[i]); sendCommandQueued('brightness',100); i=(i+1)%colors.length; },700);
    }; break;
    case 'sunriseMode': action=()=>applyPreset(2700,70); break;
    case 'sunsetMode': action=()=>applyPreset(2700,30); break;
    case 'focusMode': action=()=>applyPreset(5000,100); break;
    case 'romanticMode': action=()=>applyPreset(null,40,{r:255,g:100,b:150}); break;
    case 'energyBoostMode': action=()=>applyPreset(6500,100); break;
  }
  schedules.push({time,name:preset,action});
  const li=document.createElement('li'); li.textContent=`${time} â†’ ${preset}`; document.getElementById('scheduleList').appendChild(li);
});

// ---------------- INIT ----------------
fetchDevices().then(()=>startPolling());
setInterval(checkSchedules,60000);
});
</script>
</body>
</html>


