<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Govee Light Dashboard</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    background: #f0f2f5;
  }
  header {
    background: #2196F3;
    color: white;
    padding: 20px;
    text-align: center;
    font-size: 1.8em;
  }
  main {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    padding: 20px;
    gap: 20px;
  }
  .panel {
    background: white;
    border-radius: 12px;
    padding: 20px;
    min-width: 280px;
    max-width: 350px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }
  .panel h2 {
    margin-top: 0;
    font-size: 1.2em;
    margin-bottom: 15px;
  }
  select, input[type=color], input[type=range], button {
    width: 100%;
    margin-top: 5px;
    margin-bottom: 15px;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  button {
    border: none;
    cursor: pointer;
    font-weight: bold;
  }
  .on { background: #4CAF50; color: white; }
  .off { background: #E53935; color: white; }
  .blue { background: #2196F3; color: white; }
  #status {
    font-weight: bold;
    margin-top: 10px;
  }
  .control-group {
    display: flex;
    gap: 10px;
  }
  .control-group button {
    flex: 1;
  }
</style>
</head>
<body>

<header>ðŸ’¡ Govee Light Dashboard</header>

<main>
  <!-- Device Panel -->
  <div class="panel">
    <h2>Devices</h2>
    <button id="refresh" class="blue">ðŸ”„ Refresh Devices</button>
    <select id="deviceSelect"></select>
    <p id="status">Status: Waiting...</p>
  </div>

  <!-- Color Panel -->
  <div class="panel">
    <h2>ðŸŽ¨ Color Control</h2>
    <input type="color" id="colorPicker" value="#ffffff">
    <button id="setColor" class="blue">Set Color</button>
  </div>

  <!-- Brightness Panel -->
  <div class="panel">
    <h2>ðŸ’¡ Brightness Control</h2>
    <label>Brightness: <span id="brightnessValue">100</span>%</label>
    <input type="range" id="brightness" min="0" max="100" value="100">
    <button id="setBrightness" class="blue">Set Brightness</button>
  </div>

  <!-- Power Control Panel -->
  <div class="panel">
    <h2>Power Control</h2>
    <div class="control-group">
      <button id="turnOn" class="on">Turn ON</button>
      <button id="turnOff" class="off">Turn OFF</button>
    </div>
  </div>
</main>

<script>
const API_KEY = "f4b87beb-7426-4751-9cbd-811d08300ea8";
const API_BASE = "https://developer-api.govee.com/v1";

const statusEl = document.getElementById('status');
const deviceSelect = document.getElementById('deviceSelect');
const brightnessSlider = document.getElementById('brightness');
const brightnessValue = document.getElementById('brightnessValue');

document.getElementById('refresh').addEventListener('click', fetchDevices);
document.getElementById('setColor').addEventListener('click', setColor);
document.getElementById('setBrightness').addEventListener('click', setBrightness);
document.getElementById('turnOn').addEventListener('click', () => sendCommand('turn', 'on'));
document.getElementById('turnOff').addEventListener('click', () => sendCommand('turn', 'off'));
brightnessSlider.addEventListener('input', () => {
  brightnessValue.textContent = brightnessSlider.value;
});

async function fetchDevices() {
  statusEl.textContent = 'Status: Fetching devices...';
  try {
    const res = await fetch(`${API_BASE}/devices`, {
      headers: { 'Govee-API-Key': API_KEY }
    });
    const data = await res.json();
    const devices = data.data?.devices || [];
    deviceSelect.innerHTML = '';
    if (devices.length === 0) {
      const opt = document.createElement('option');
      opt.textContent = '-- No devices found --';
      deviceSelect.appendChild(opt);
      statusEl.textContent = 'No devices found. Check API key.';
      return;
    }
    devices.forEach(dev => {
      const opt = document.createElement('option');
      opt.value = JSON.stringify(dev);
      opt.textContent = dev.deviceName || dev.model || 'Unknown Device';
      deviceSelect.appendChild(opt);
    });
    statusEl.textContent = `Found ${devices.length} device(s).`;
  } catch (err) {
    console.error(err);
    statusEl.textContent = 'Error fetching devices.';
  }
}

async function sendCommand(name, value) {
  if (!deviceSelect.value) {
    statusEl.textContent = 'Select a device first';
    return;
  }

  const selected = JSON.parse(deviceSelect.value);
  const deviceId = selected.device || selected.deviceId || selected.deviceName;
  const model = selected.model || selected.sku || selected.deviceType;

  if (!deviceId || !model) {
    statusEl.textContent = 'Error: Device or model missing.';
    return;
  }

  const body = { device: deviceId, model, cmd: { name, value } };

  try {
    const res = await fetch(`${API_BASE}/devices/control`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Govee-API-Key': API_KEY },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (res.ok && data.message === "success") {
      statusEl.textContent = 'âœ… Command sent successfully!';
    } else {
      statusEl.textContent = 'âš ï¸ Error: ' + JSON.stringify(data);
    }
  } catch (err) {
    console.error(err);
    statusEl.textContent = 'âŒ Failed to send command.';
  }
}

function hexToRgb(hex) {
  const bigint = parseInt(hex.slice(1), 16);
  return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
}

function setColor() {
  const hex = document.getElementById('colorPicker').value;
  const rgb = hexToRgb(hex);
  sendCommand('color', rgb);
}

function setBrightness() {
  const val = parseInt(brightnessSlider.value);
  sendCommand('brightness', val);
}

// Initial fetch
fetchDevices();
</script>
</body>
</html>

</html>
